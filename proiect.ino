#include <LedControl.h>
#define FORWARD 0
#define LEFT 1
#define RIGHT 2
#define STATE_ON 1
#define STATE_OFF 0

unsigned const int LED_LEFT = 2;
unsigned const int LED_RIGHT = 6;
unsigned const int LED_FORWARD = 7;
unsigned const int BUTTON_LEFT = 3;
unsigned const int BUTTON_RIGHT = 4;
unsigned const int BUTTON_FORWARD = 5;
unsigned int directionToMove = FORWARD; // By default is set to forward
unsigned int flickeringState = STATE_ON;
unsigned const int DIN = 10;
unsigned const int CS = 9;
unsigned const int CLK = 8;
LedControl lc = LedControl(DIN, CLK, CS, 0);
unsigned int offset = 0;
//byte arrowUp[8][8] = {{0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00},
//                      {0x3C,0x7E,0x18,0x18,0x18,0x18,0x00,0x18},
//                      {0x7E,0x18,0x18,0x18,0x18,0x00,0x18,0x3C},
//                      {0x18,0x18,0x18,0x18,0x00,0x18,0x3C,0x7E},
//                      {0x18,0x18,0x18,0x00,0x18,0x3C,0x7E,0x18},
//                      {0x18,0x18,0x00,0x18,0x3C,0x7E,0x18,0x18},
//                      {0x18,0x00,0x18,0x3C,0x7E,0x18,0x18,0x18},
//                      {0x00,0x18,0x3C,0x7E,0x18,0x18,0x18,0x18}};
//
//byte arrowRight[8][8] = {{0x00,0x04,0x06,0x7F,0x7F,0x06,0x04,0x00},
//                        {0x00,0x02,0x03,0xBF,0xBF,0x03,0x02,0x00},
//                        {0x00,0x01,0x81,0xDF,0xDF,0x81,0x01,0x00},
//                        {0x00,0x80,0xC0,0xEF,0xEF,0xC0,0x80,0x00},
//                        {0x00,0x40,0x60,0xF7,0xF7,0x60,0x40,0x00},
//                        {0x00,0x20,0x30,0xFB,0xFB,0x30,0x20,0x00},
//                        {0x00,0x10,0x18,0xFD,0xFD,0x18,0x10,0x00},
//                        {0x00,0x08,0x0C,0xFE,0xFE,0x0C,0x08,0x00}};
//
//byte arrowLeft[8][8] = {{0x00,0x20,0x60,0xFE,0xFE,0x60,0x20,0x00},
//                        {0x00,0x40,0xC0,0xFD,0xFD,0xC0,0x40,0x00},
//                        {0x00,0x80,0x81,0xFB,0xFB,0x81,0x80,0x00},
//                        {0x00,0x01,0x03,0xF7,0xF7,0x03,0x01,0x00},
//                        {0x00,0x02,0x06,0xEF,0xEF,0x06,0x02,0x00},
//                        {0x00,0x04,0x0C,0xDF,0xDF,0x0C,0x04,0x00},
//                        {0x00,0x08,0x18,0xBF,0xBF,0x18,0x08,0x00},
//                        {0x00,0x10,0x30,0x7F,0x7F,0x30,0x10,0x00}};

byte arrows[3][8][8] = {{{0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00},
                      {0x3C,0x7E,0x18,0x18,0x18,0x18,0x00,0x18},
                      {0x7E,0x18,0x18,0x18,0x18,0x00,0x18,0x3C},
                      {0x18,0x18,0x18,0x18,0x00,0x18,0x3C,0x7E},
                      {0x18,0x18,0x18,0x00,0x18,0x3C,0x7E,0x18},
                      {0x18,0x18,0x00,0x18,0x3C,0x7E,0x18,0x18},
                      {0x18,0x00,0x18,0x3C,0x7E,0x18,0x18,0x18},
                      {0x00,0x18,0x3C,0x7E,0x18,0x18,0x18,0x18}},// UP
                      
                      {{0x00,0x20,0x60,0xFE,0xFE,0x60,0x20,0x00},
                      {0x00,0x40,0xC0,0xFD,0xFD,0xC0,0x40,0x00},
                      {0x00,0x80,0x81,0xFB,0xFB,0x81,0x80,0x00},
                      {0x00,0x01,0x03,0xF7,0xF7,0x03,0x01,0x00},
                      {0x00,0x02,0x06,0xEF,0xEF,0x06,0x02,0x00},
                      {0x00,0x04,0x0C,0xDF,0xDF,0x0C,0x04,0x00},
                      {0x00,0x08,0x18,0xBF,0xBF,0x18,0x08,0x00},
                      {0x00,0x10,0x30,0x7F,0x7F,0x30,0x10,0x00}}, // LEFT
                      
                      {{0x00,0x04,0x06,0x7F,0x7F,0x06,0x04,0x00},
                      {0x00,0x02,0x03,0xBF,0xBF,0x03,0x02,0x00},
                      {0x00,0x01,0x81,0xDF,0xDF,0x81,0x01,0x00},
                      {0x00,0x80,0xC0,0xEF,0xEF,0xC0,0x80,0x00},
                      {0x00,0x40,0x60,0xF7,0xF7,0x60,0x40,0x00},
                      {0x00,0x20,0x30,0xFB,0xFB,0x30,0x20,0x00},
                      {0x00,0x10,0x18,0xFD,0xFD,0x18,0x10,0x00},
                      {0x00,0x08,0x0C,0xFE,0xFE,0x0C,0x08,0x00}}// RIGHT
                      }; 

void setup() {
  Serial.begin(9600);
  pinMode(BUTTON_LEFT, INPUT_PULLUP);
  pinMode(BUTTON_RIGHT, INPUT_PULLUP);
  pinMode(BUTTON_FORWARD, INPUT_PULLUP);

  pinMode(LED_LEFT, OUTPUT);
  pinMode(LED_FORWARD, OUTPUT);
  pinMode(LED_RIGHT, OUTPUT);

  lc.shutdown(0, false);
  lc.setIntensity(0, 15);
  lc.clearDisplay(0);
  
  cli();

  TCCR1A = 0;
  TCCR1B = 0;
  TCNT1  = 0;

  OCR1A = 31249;            // compare match register 16MHz/256/2Hz-1
  TCCR1B |= (1 << WGM12);   // CTC mode
  TCCR1B |= (1 << CS12);    // 256 prescaler
  TIMSK1 |= (1 << OCIE1A);  // enable timer compare interrupt
  sei();
}

void turnOffMatrix() {
  digitalWrite(LED_LEFT, LOW);
  digitalWrite(LED_RIGHT, LOW);
  digitalWrite(LED_FORWARD, LOW);
}

void printByte(byte object[]) {
  for (int i = 0; i < 8; ++i) {
    lc.setRow(0, i, object[i]);
  }
}

void printMatrix() {
  if (flickeringState == STATE_ON) {
    if (directionToMove == LEFT) {
      digitalWrite(LED_LEFT, HIGH);
    } else if (directionToMove == RIGHT) {
      digitalWrite(LED_RIGHT, HIGH);
    } else if (directionToMove == FORWARD) {
      digitalWrite(LED_FORWARD, HIGH);
    }
  } else {
    turnOffMatrix();
  }
  
}

ISR(TIMER1_COMPA_vect) {
//  Serial.println(directionToMove, DEC);

  // how quick to change the state
  OCR1A += 1000;
  offset += 1;
  offset %= 8;

  flickeringState = 1 - flickeringState;
  printMatrix();
  printByte(arrows[directionToMove][offset]);
}

void readButtonInput() {
  int leftSignal, rightSignal, forwardSignal;

  leftSignal = digitalRead(BUTTON_LEFT);
  rightSignal = digitalRead(BUTTON_RIGHT);
  forwardSignal = digitalRead(BUTTON_FORWARD);

  if (leftSignal == LOW) {
    directionToMove = LEFT;
    turnOffMatrix();
  } else if (rightSignal == LOW) {
    directionToMove = RIGHT;
    turnOffMatrix();
  } else if (forwardSignal == LOW) {
    directionToMove = FORWARD;
    turnOffMatrix();
  }
}

void loop()
{
  readButtonInput();
}
